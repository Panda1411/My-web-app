<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mindmaps – Thought Chains</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap UI framework -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    :root {
      --mm-bg: #020617;
      --mm-surface: #020617;
      --mm-soft: #020617;
      --mm-border-subtle: #1e293b;
      --mm-border-strong: #334155;
      --mm-text: #e5e7eb;
      --mm-muted: #9ca3af;
      --mm-accent: #38bdf8;
      --mm-accent-soft: rgba(56, 189, 248, 0.2);
      --mm-danger: #f97373;
      --mm-success: #4ade80;
    }

    [data-theme="light"] {
      --mm-bg: #f3f4f6;
      --mm-surface: #ffffff;
      --mm-soft: #f9fafb;
      --mm-border-subtle: #e5e7eb;
      --mm-border-strong: #cbd5f5;
      --mm-text: #020617;
      --mm-muted: #6b7280;
      --mm-accent: #0ea5e9;
      --mm-accent-soft: rgba(14, 165, 233, 0.18);
      --mm-danger: #ef4444;
      --mm-success: #22c55e;
    }

    [data-theme="slate"] {
      --mm-bg: #020617;
      --mm-surface: #020617;
      --mm-soft: #020617;
      --mm-border-subtle: #111827;
      --mm-border-strong: #1f2937;
      --mm-text: #e5e7eb;
      --mm-muted: #9ca3af;
      --mm-accent: #6366f1;
      --mm-accent-soft: rgba(99, 102, 241, 0.22);
      --mm-danger: #f97373;
      --mm-success: #4ade80;
    }

    [data-theme="indigo"] {
      --mm-bg: #020617;
      --mm-surface: #020617;
      --mm-soft: #020617;
      --mm-border-subtle: #1e293b;
      --mm-border-strong: #312e81;
      --mm-text: #e5e7eb;
      --mm-muted: #a5b4fc;
      --mm-accent: #4f46e5;
      --mm-accent-soft: rgba(79, 70, 229, 0.24);
      --mm-danger: #f97373;
      --mm-success: #4ade80;
    }
    [data-theme="forest"] {
  /* Bright, fresh green workspace */
  --mm-bg: #ecfdf5;
  --mm-surface: #ffffff;
  --mm-soft: #d1fae5;
  --mm-border-subtle: #6ee7b7;
  --mm-border-strong: #34d399;
  --mm-text: #022c22;
  --mm-muted: #065f46;
  --mm-accent: #10b981;
  --mm-accent-soft: rgba(16,185,129,0.25);
  --mm-danger: #dc2626;
  --mm-success: #16a34a;
}


[data-theme="solar"] {
  --mm-bg: #fdf6e3;
  --mm-surface: #fefcf5;
  --mm-soft: #f5ecd6;
  --mm-border-subtle: #e5dec7;
  --mm-border-strong: #d4c89a;
  --mm-text: #334155;
  --mm-muted: #6b7280;
  --mm-accent: #f59e0b;
  --mm-accent-soft: rgba(245, 158, 11, 0.22);
  --mm-danger: #ef4444;
  --mm-success: #16a34a;
}

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      background-color: var(--mm-bg);
      color: var(--mm-text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Roboto", sans-serif;
    }

    .mm-app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .mm-card {
      background-color: var(--mm-surface) !important;
      border-color: var(--mm-border-subtle) !important;
      color: var(--mm-text);
    }

    .mm-soft {
      background-color: var(--mm-soft);
    }

    .mm-muted {
      color: var(--mm-muted);
    }

    .mm-border-subtle {
      border-color: var(--mm-border-subtle) !important;
    }

    .mm-pill {
      border-radius: 999px;
      border: 1px solid var(--mm-border-strong);
      background-color: var(--mm-soft);
      padding: 5px 10px;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--mm-muted);
    }

    .mm-pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background-color: var(--mm-accent);
    }

    .mm-header-btn {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: 1px solid var(--mm-border-strong);
      background-color: var(--mm-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--mm-text);
      cursor: pointer;
      font-size: 0.9rem;
    }

    .mm-header-btn:active {
      transform: scale(0.96);
    }

    .mm-tab-btn {
      font-size: 0.9rem;
      padding: 6px 12px;
      border-radius: 999px !important;
      border: none;
      color: var(--mm-muted);
      background-color: transparent;
    }

    .mm-tab-btn.active {
      background-color: var(--mm-accent-soft);
      color: var(--mm-text);
    }

    /* Inputs / buttons */

    textarea,
    input[type="text"] {
      background-color: var(--mm-soft) !important;
      border-color: var(--mm-border-subtle) !important;
      color: var(--mm-text) !important;
      font-size: 0.9rem !important;
    }

    textarea:focus,
    input[type="text"]:focus {
      border-color: var(--mm-accent) !important;
      box-shadow: 0 0 0 1px var(--mm-accent-soft) !important;
    }

    .mm-btn-main {
      background-color: var(--mm-accent) !important;
      border-color: var(--mm-accent) !important;
      color: #020617 !important;
      font-weight: 500;
    }

    .mm-btn-subtle {
      background-color: var(--mm-soft) !important;
      border-color: var(--mm-border-subtle) !important;
      color: var(--mm-muted) !important;
    }

    /* Elements list */

    .mm-element-row {
      font-size: 0.9rem;
      border-bottom: 1px solid var(--mm-border-subtle);
      cursor: pointer;
    }

    .mm-element-row:last-child {
      border-bottom: none;
    }

    .mm-element-row:hover {
      background-color: rgba(148, 163, 184, 0.15);
    }

    .mm-element-id {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .mm-element-text {
      font-size: 0.9rem;
      white-space: normal;
      word-wrap: break-word;
    }

    .mm-mini-btn {
      font-size: 0.75rem;
      padding: 2px 6px;
      border-radius: 999px;
      border-width: 1px;
      background: transparent;
    }

    .mm-mini-primary {
      border-color: var(--mm-accent);
      color: var(--mm-accent);
    }

    .mm-mini-danger {
      border-color: var(--mm-danger);
      color: var(--mm-danger);
    }

    /* Chain arrow diagram */

    .mm-chain-diagram {
      white-space: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 8px;
      background-color: var(--mm-soft);
      border-radius: 8px;
      border: 1px solid var(--mm-border-subtle);
      min-height: 60px;
    }

    .mm-chain-node {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 10px;
      margin: 2px;
      border-radius: 999px;
      border: 1px solid var(--mm-border-subtle);
      background-color: var(--mm-surface);
      font-size: 0.9rem;
      font-weight: 500;
    }

    .mm-chain-arrow {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin: 0 4px;
      color: var(--mm-accent);
      font-size: 1rem;
    }

    .mm-chain-empty {
      font-size: 0.9rem;
      color: var(--mm-muted);
    }

    /* Analysis */

    .mm-stat-box {
      border-radius: 8px;
      border: 1px solid var(--mm-border-subtle);
      background-color: var(--mm-soft);
      padding: 8px;
      font-size: 0.9rem;
      max-height: 180px;
      overflow-y: auto;
    }

    .mm-stat-row {
      display: flex;
      justify-content: space-between;
      padding: 3px 0;
      border-bottom: 1px dashed var(--mm-border-subtle);
    }

    .mm-stat-row:last-child {
      border-bottom: none;
    }

    .mm-stat-empty {
      font-size: 0.9rem;
      color: var(--mm-muted);
    }

    .mm-metric-badge {
      font-size: 0.95rem;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid var(--mm-border-subtle);
      background-color: var(--mm-soft);
    }

    .mm-metric-label {
      font-size: 0.8rem;
      color: var(--mm-muted);
    }

    .mm-metric-value {
      font-size: 1.1rem;
      font-weight: 600;
    }

    /* Thought history */

    .mm-history-item {
      border-bottom: 1px solid var(--mm-border-subtle);
      padding: 6px 0;
      font-size: 0.9rem;
    }

    .mm-history-item:last-child {
      border-bottom: none;
    }

    .mm-tag-pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid var(--mm-border-subtle);
      font-size: 0.75rem;
      margin-right: 4px;
      margin-bottom: 2px;
    }

    /* Settings */

    .mm-theme-pill {
      font-size: 0.8rem;
      border-radius: 999px;
      padding: 4px 10px;
      border: none;
      background: transparent;
      color: var(--mm-muted);
    }

    .mm-theme-pill.active {
      background-color: var(--mm-accent-soft);
      color: var(--mm-text);
    }

    .mm-log-box {
      border-radius: 8px;
      border: 1px solid var(--mm-border-subtle);
      background-color: var(--mm-soft);
      max-height: 140px;
      overflow-y: auto;
      font-size: 0.8rem;
      padding: 4px 0;
    }

    .mm-log-entry {
      padding: 2px 8px;
      border-bottom: 1px dashed var(--mm-border-subtle);
    }

    .mm-log-entry:last-child {
      border-bottom: none;
    }

    .mm-log-entry span {
      color: var(--mm-accent);
    }

    /* Modal */

    .mm-modal-body {
      max-height: 320px;
      overflow-y: auto;
      font-size: 0.9rem;
      white-space: pre-wrap;
    }
  </style>
</head>
<body data-theme="dark">
  <div class="mm-app">

    <!-- HEADER -->
    <div class="card mm-card mb-1">
      <div class="card-body py-2 d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
          <div
            class="d-flex align-items-center justify-content-center"
            style="width:40px;height:40px;border-radius:10px;border:1px solid var(--mm-border-strong);background-color:var(--mm-soft);font-weight:600;font-size:1rem;"
          >
           ✓
          </div>
          <div>
            <div style="font-size:1.1rem;font-weight:600;letter-spacing:0.15em;text-transform:uppercase;">
              Mindmaps
            </div>
            <div class="mm-muted" style="font-size:0.9rem;">
              Thought Chain Console
            </div>
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <div class="mm-pill" id="headerStatus">
            <div class="mm-pill-dot"></div>
            <span>Local graph · Firebase optional</span>
          </div>
          <button class="mm-header-btn" id="themeToggle" title="Toggle main theme">
            ☼
          </button>
        </div>
      </div>
    </div>

    <!-- NAV / TABS -->
    <div class="d-flex justify-content-between align-items-center mb-1">
      <div class="mm-muted" style="font-size:0.9rem;">Workspace</div>
      <div class="border rounded-pill px-1 py-1 mm-border-subtle mm-soft">
        <button class="mm-tab-btn active" data-tab="builder">Builder</button>
        <button class="mm-tab-btn" data-tab="analysis">Analysis</button>
        <button class="mm-tab-btn" data-tab="settings">Settings</button>
      </div>
    </div>

    <!-- TABS CONTENT -->
    <div class="flex-fill d-flex flex-column" style="min-height:0;">

      <!-- BUILDER TAB -->
      <div id="tab-builder" class="tab-pane active d-flex flex-column gap-2" style="min-height:0;">
        <div class="row g-2 flex-fill">
          <!-- Elements -->
          <div class="col-12 col-lg-5 d-flex">
            <div class="card mm-card flex-fill">
              <div class="card-body py-2 d-flex flex-column h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <div style="font-size:0.95rem;font-weight:600;">Elements</div>
                    <div class="mm-muted" style="font-size:0.85rem;">
                      Full text stored, shown here; IDs used in chains.
                    </div>
                  </div>
                  <span class="badge rounded-pill mm-border-subtle" id="elementCountChip"
                    style="font-size:0.85rem;">0 elements</span>
                </div>

                <div class="mb-2">
                  <textarea
                    id="newElementText"
                    class="form-control form-control-sm"
                    rows="3"
                    placeholder="Write the full statement for this element. Example: 'I checked my phone before starting the task.'"
                  ></textarea>
                </div>
                <div class="d-flex gap-2 mb-2">
                  <button class="btn btn-sm mm-btn-main flex-fill" id="addElementBtn">Add element</button>
                </div>
                <div class="mm-muted mb-2" style="font-size:0.85rem;">
                  Tap an element row to append it to the current chain. Full text is always visible here and in View.
                </div>

                <div
  id="elementsList"
  class="mm-soft mm-border-subtle border rounded"
  style="overflow-y:auto; max-height:260px; font-size:0.95rem;"
>
  <div class="p-2 mm-muted">No elements yet. Create one above.</div>
</div>

              </div>
            </div>
          </div>

          <!-- Chain builder -->
          <div class="col-12 col-lg-7 d-flex">
            <div class="card mm-card flex-fill">
              <div class="card-body py-2 d-flex flex-column h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <div style="font-size:0.95rem;font-weight:600;">Chain builder</div>
                 
                  </div>
                  <span class="badge rounded-pill mm-border-subtle" id="chainLengthChip"
                    style="font-size:0.85rem;">0 steps</span>
                </div>

                <div id="chainView" class="mm-chain-diagram mb-2">
                  <span class="mm-chain-empty">Chain is empty. Tap elements on the left to build it.</span>
                </div>

                <div class="d-flex gap-2 mb-2">
                  <button class="btn btn-sm mm-btn-main flex-fill" id="saveChainBtn">Save chain</button>
                  <button class="btn btn-sm mm-btn-subtle" id="undoChainBtn">Undo</button>
                  <button class="btn btn-sm mm-btn-subtle" id="redoChainBtn">Redo</button>
                  <button class="btn btn-sm mm-btn-subtle" id="clearChainBtn">Clear</button>
                </div>

                <div class="mb-2">
                  <input
                    type="text"
                    id="tagsInput"
                    class="form-control form-control-sm"
                    placeholder="Optional tags, comma separated (e.g. 'study, distraction, late-night')"
                  />
                </div>
                <div class="mb-1">
                  <textarea
                    id="contextInput"
                    class="form-control form-control-sm"
                    rows="3"
                    placeholder="Context (situation, mood, trigger for this chain)…"
                  ></textarea>
                </div>
                <div class="mm-muted" style="font-size:0.85rem;">
                  Context and tags are stored with each chain and shown in history & analysis.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ANALYSIS TAB -->
      <div id="tab-analysis" class="tab-pane d-none flex-column gap-2" style="min-height:0;">
        <div class="row g-2 flex-fill">
          <!-- Analysis / metrics -->
          <div class="col-12 col-lg-7 d-flex">
            <div class="card mm-card flex-fill">
              <div class="card-body py-2 d-flex flex-column h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <div style="font-size:0.95rem;font-weight:600;">Analytics</div>
                 
                  </div>
                  <span class="badge rounded-pill mm-border-subtle" id="thoughtCountChip"
                    style="font-size:0.85rem;">0 chains</span>
                </div>

                <!-- Metrics row -->
                <div class="row g-2 mb-2">
                  <div class="col-6 col-md-3">
                    <div class="mm-metric-badge h-100">
                      <div class="mm-metric-label">Total elements</div>
                      <div class="mm-metric-value" id="metricTotalElements">0</div>
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="mm-metric-badge h-100">
                      <div class="mm-metric-label">Total chains</div>
                      <div class="mm-metric-value" id="metricTotalChains">0</div>
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="mm-metric-badge h-100">
                      <div class="mm-metric-label">Avg length</div>
                      <div class="mm-metric-value" id="metricAvgLength">0</div>
                    </div>
                  </div>
                  <div class="col-6 col-md-3">
                    <div class="mm-metric-badge h-100">
                      <div class="mm-metric-label">Most used node</div>
                      <div class="mm-metric-value" id="metricMostUsed">–</div>
                    </div>
                  </div>
                </div>

                <!-- Transition stats -->
                <div class="mb-2">
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <div style="font-size:0.9rem;font-weight:500;">Transitions</div>
                    <div class="mm-muted" style="font-size:0.8rem;">
                      Frequencies of E-i → E-j inside chains
                    </div>
                  </div>
                  <div class="mm-stat-box" id="transitionStats">
                    <div class="mm-stat-empty">No data yet.</div>
                  </div>
                </div>

                <!-- Start/end distribution -->
                <div class="row g-2">
                  <div class="col-6">
                    <div class="mb-1" style="font-size:0.9rem;font-weight:500;">Start nodes</div>
                    <div class="mm-stat-box" id="startStats">
                      <div class="mm-stat-empty">No data yet.</div>
                    </div>
                  </div>
                  <div class="col-6">
                    <div class="mb-1" style="font-size:0.9rem;font-weight:500;">End nodes</div>
                    <div class="mm-stat-box" id="endStats">
                      <div class="mm-stat-empty">No data yet.</div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
          <!-- Element usage and tag counts -->
<div class="row g-2 mt-2">
  <div class="col-6">
    <div class="mb-1" style="font-size:0.9rem;font-weight:500;">Element usage</div>
    <div class="mm-stat-box" id="elementStats">
      <div class="mm-stat-empty">No data yet.</div>
    </div>
  </div>
  <div class="col-6">
    <div class="mb-1" style="font-size:0.9rem;font-weight:500;">Tag counts</div>
    <div class="mm-stat-box" id="tagStats">
      <div class="mm-stat-empty">No data yet.</div>
    </div>
  </div>
</div>

          <!-- Thought history -->
          <div class="col-12 col-lg-5 d-flex">
            <div class="card mm-card flex-fill">
              <div class="card-body py-2 d-flex flex-column h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <div>
                    <div style="font-size:0.95rem;font-weight:600;">Thought history</div>
                    <div class="mm-muted" style="font-size:0.85rem;">
                      Every saved chain with timestamp, tags, and IDs.
                    </div>
                  </div>
                </div>
                <div
                  id="thoughtHistory"
                  class="mm-soft mm-border-subtle border rounded flex-fill"
                  style="overflow-y:auto; font-size:0.9rem;"
                >
                  <div class="p-2 mm-muted">No chains yet.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- SETTINGS TAB -->
      <div id="tab-settings" class="tab-pane d-none flex-column gap-2" style="min-height:0;">
        <div class="card mm-card flex-fill">
          <div class="card-body py-2 d-flex flex-column h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <div style="font-size:0.95rem;font-weight:600;">Settings</div>
                <div class="mm-muted" style="font-size:0.85rem;">
                  Theme and Firestore diagnostics
                </div>
              </div>
              <span class="badge rounded-pill mm-border-subtle" id="firebaseStatus"
                style="font-size:0.85rem;">Firebase: not initialised</span>
            </div>

            <div class="mb-2">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <div>
                  <div style="font-size:0.9rem;font-weight:500;">Theme</div>
                  
                </div>
                <div class="d-flex gap-1 flex-wrap">
  
  <button class="mm-theme-pill" data-theme-choice="light">Light</button>


  <button class="mm-theme-pill" data-theme-choice="forest">Forest</button>
  <button class="mm-theme-pill" data-theme-choice="solar">Solar</button>

</div>
              </div>
            </div>

            <div class="mb-2">
              <div style="font-size:0.9rem;font-weight:500;">Firestore access</div>
              <div class="mm-muted" style="font-size:0.8rem;" id="firebaseHint">
                If you see "Missing or insufficient permissions" in the log, update Firestore rules to allow reads/writes for testing.
              </div>
            </div>

            <div class="mb-1">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <div style="font-size:0.9rem;font-weight:500;">Event log</div>
              </div>
              <div class="mm-log-box" id="logArea"></div>
            </div>

            <div class="mm-muted" style="font-size:0.8rem;">
              Deleting an element will also delete every thought chain that uses that element, both in memory and in Firestore.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Element / context modal -->
  <div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content mm-card">
        <div class="modal-header border-0 pb-1">
          <h6 class="modal-title" id="modalTitle">Details</h6>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body mm-modal-body" id="modalBody"></div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (for modal) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    /* ========== THEME ========== */
    const root = document.body;
    const themeToggle = document.getElementById("themeToggle");
    const themePills = document.querySelectorAll(".mm-theme-pill");

    function setTheme(mode) {
      if (mode === "system") {
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        root.setAttribute("data-theme", prefersDark ? "dark" : "light");
      } else {
        root.setAttribute("data-theme", mode);
      }
      localStorage.setItem("mindmaps-theme", mode);
      themePills.forEach(pill => {
        pill.classList.toggle("active", pill.dataset.themeChoice === mode);
      });
    }

    const initialTheme = localStorage.getItem("mindmaps-theme") || "dark";
    setTheme(initialTheme);

    themeToggle.addEventListener("click", () => {
      const stored = localStorage.getItem("mindmaps-theme") || "dark";
      const current =
        stored === "system"
          ? (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light")
          : stored;
      const next = current === "dark" ? "light" : "dark";
      setTheme(next);
    });

    themePills.forEach(pill => {
      pill.addEventListener("click", () => {
        setTheme(pill.dataset.themeChoice);
      });
    });

    /* ========== LOGGING ========== */
    const logArea = document.getElementById("logArea");
    const LOG_LIMIT = 100;
    function logEvent(msg) {
      const now = new Date();
      const t = `${String(now.getHours()).padStart(2, "0")}:${String(
        now.getMinutes()
      ).padStart(2, "0")}`;
      const div = document.createElement("div");
      div.className = "mm-log-entry";
      div.innerHTML = `<span>[${t}]</span> ${msg}`;
      logArea.prepend(div);
      while (logArea.children.length > LOG_LIMIT) {
        logArea.removeChild(logArea.lastChild);
      }
    }

    /* ========== TABS ========== */
    const tabButtons = document.querySelectorAll(".mm-tab-btn");
    const tabBuilder = document.getElementById("tab-builder");
    const tabAnalysis = document.getElementById("tab-analysis");
    const tabSettings = document.getElementById("tab-settings");
    const tabMap = { builder: tabBuilder, analysis: tabAnalysis, settings: tabSettings };

    tabButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const target = btn.dataset.tab;
        tabButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        Object.entries(tabMap).forEach(([key, el]) => {
          el.classList.toggle("d-none", key !== target);
          el.classList.toggle("d-flex", key === target);
        });
      });
    });

    /* ========== FIREBASE ========== */
    const firebaseStatus = document.getElementById("firebaseStatus");
    const firebaseHint = document.getElementById("firebaseHint");
    const headerStatus = document.getElementById("headerStatus");
    let db = null;

    const firebaseConfig = {
      apiKey: "AIzaSyCecQWk3AdWqA016gFtamAxmnQrS58I3Fs",
      authDomain: "mindmap-58ea4.firebaseapp.com",
      projectId: "mindmap-58ea4",
      storageBucket: "mindmap-58ea4.firebasestorage.app",
      messagingSenderId: "984406880104",
      appId: "1:984406880104:web:b877f2210873775f3170dd",
      measurementId: "G-YJT43715BT",
    };

    (function initFirebase() {
      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        firebaseStatus.textContent = "Firebase: initialised";
        firebaseStatus.style.color = "var(--mm-success)";
        headerStatus.querySelector("span").textContent = "      Firestore connected";
        logEvent("Firebase initialised.");
      } catch (e) {
        db = null;
        firebaseStatus.textContent = "Firebase error";
        firebaseStatus.style.color = "var(--mm-danger)";
        headerStatus.querySelector("span").textContent = "Local graph · Firebase error";
        firebaseHint.textContent = "Firestore failed; app is running purely in memory.";
        logEvent("Firebase init failed: " + e.message);
      }
    })();

    /* ========== DATA STATE ========== */
    let elements = [];       // [{ key, text, createdAt }]
    let currentChain = [];   // [key]
    let thoughtChains = [];  // [{ id, chain, tags, context, timestamp }]

    // undo/redo stacks for chain
    let undoStack = [];
    let redoStack = [];

    /* ========== DOM REFS ========== */
    const elementsListEl = document.getElementById("elementsList");
    const elementCountChip = document.getElementById("elementCountChip");
    const newElementText = document.getElementById("newElementText");
    const addElementBtn = document.getElementById("addElementBtn");

    const chainView = document.getElementById("chainView");
    const chainLengthChip = document.getElementById("chainLengthChip");
    const saveChainBtn = document.getElementById("saveChainBtn");
    const undoChainBtn = document.getElementById("undoChainBtn");
    const redoChainBtn = document.getElementById("redoChainBtn");
    const clearChainBtn = document.getElementById("clearChainBtn");
    const tagsInput = document.getElementById("tagsInput");
    const contextInput = document.getElementById("contextInput");

    const thoughtCountChip = document.getElementById("thoughtCountChip");
    const transitionStatsEl = document.getElementById("transitionStats");
    const elementStatsEl = document.getElementById("elementStats");
    const tagStatsEl = document.getElementById("tagStats");
    const startStatsEl = document.getElementById("startStats");
    const endStatsEl = document.getElementById("endStats");
    const thoughtHistoryEl = document.getElementById("thoughtHistory");

    const metricTotalElements = document.getElementById("metricTotalElements");
    const metricTotalChains = document.getElementById("metricTotalChains");
    const metricAvgLength = document.getElementById("metricAvgLength");
    const metricMostUsed = document.getElementById("metricMostUsed");

    const modalTitle = document.getElementById("modalTitle");
    const modalBody = document.getElementById("modalBody");
    const viewModal = new bootstrap.Modal(document.getElementById("viewModal"));

    function openModal(title, body) {
      modalTitle.textContent = title;
      modalBody.textContent = body;
      viewModal.show();
    }

    /* ========== HELPERS ========== */
    function getLabelForKey(key) {
      const idx = elements.findIndex(e => e.key === key);
      if (idx === -1) return key;
      return "E-" + (idx + 1);
    }

    function formatTimestamp(ts) {
      if (!ts) return "Unknown";
      try {
        let date;
        if (ts.toDate) date = ts.toDate();
        else date = new Date(ts);
        if (Number.isNaN(date.getTime())) return "Unknown";
        const d = date.toLocaleDateString(undefined, {
          year: "numeric",
          month: "short",
          day: "2-digit",
        });
        const t = date.toLocaleTimeString(undefined, {
          hour: "2-digit",
          minute: "2-digit",
        });
        return `${d} ${t}`;
      } catch {
        return "Unknown";
      }
    }

    function snapshotChain() {
      undoStack.push([...currentChain]);
      if (undoStack.length > 100) undoStack.shift();
      redoStack = [];
      updateUndoRedoButtons();
    }

    function updateUndoRedoButtons() {
      undoChainBtn.disabled = undoStack.length === 0;
      redoChainBtn.disabled = redoStack.length === 0;
    }

    /* ========== RENDER: ELEMENTS ========== */
    function renderElements() {
      elementsListEl.innerHTML = "";
      elementCountChip.textContent = `${elements.length} element${elements.length === 1 ? "" : "s"}`;

      if (elements.length === 0) {
        const empty = document.createElement("div");
        empty.className = "p-2 mm-muted";
        empty.textContent = "No elements yet. Create one above.";
        elementsListEl.appendChild(empty);
        return;
      }

      elements.forEach((el, index) => {
        const row = document.createElement("div");
        row.className = "mm-element-row px-2 py-1 d-flex justify-content-between align-items-start";

        const left = document.createElement("div");
        left.className = "me-2 flex-grow-1";
        const idLine = document.createElement("div");
        idLine.className = "mm-element-id";
        idLine.textContent = "E-" + (index + 1);
        const textLine = document.createElement("div");
        textLine.className = "mm-element-text";
        textLine.textContent = el.text;
        left.appendChild(idLine);
        left.appendChild(textLine);

        const actions = document.createElement("div");
        actions.className = "d-flex flex-column gap-1";
        const viewBtn = document.createElement("button");
        viewBtn.className = "mm-mini-btn mm-mini-primary btn btn-sm";
        viewBtn.textContent = "View";
        viewBtn.addEventListener("click", e => {
          e.stopPropagation();
          openModal("Element " + getLabelForKey(el.key), el.text);
        });
        const delBtn = document.createElement("button");
        delBtn.className = "mm-mini-btn mm-mini-danger btn btn-sm";
        delBtn.textContent = "Delete";
        delBtn.addEventListener("click", e => {
          e.stopPropagation();
          if (confirm("Delete this element and all thoughts that use it?")) {
            deleteElementWithThoughts(el.key);
          }
        });
        actions.appendChild(viewBtn);
        actions.appendChild(delBtn);

        row.appendChild(left);
        row.appendChild(actions);
        row.addEventListener("click", () => {
          snapshotChain();
          addToChain(el.key, false); // snapshot already done
        });

        elementsListEl.appendChild(row);
      });
    }

    /* ========== RENDER: CHAIN (arrow diagram) ========== */
    function renderChain() {
      chainView.innerHTML = "";
      chainLengthChip.textContent = `${currentChain.length} step${currentChain.length === 1 ? "" : "s"}`;

      if (currentChain.length === 0) {
        const empty = document.createElement("span");
        empty.className = "mm-chain-empty";
        empty.textContent = "Chain is empty. Tap elements on the left to build it.";
        chainView.appendChild(empty);
        return;
      }

      currentChain.forEach((key, idx) => {
        if (idx > 0) {
          const arrow = document.createElement("span");
          arrow.className = "mm-chain-arrow";
          arrow.textContent = "➜";
          chainView.appendChild(arrow);
        }
        const node = document.createElement("div");
        node.className = "mm-chain-node";
        node.textContent = getLabelForKey(key);
        chainView.appendChild(node);
      });
    }

    /* ========== RENDER: ANALYSIS & HISTORY ========== */
    function renderAnalysis() {
      // metrics
      const totalElements = elements.length;
      const totalChains = thoughtChains.length;
      let totalSteps = 0;
      const usage = {};
      const startCounts = {};
      const endCounts = {};
      const transitions = {};
      const tagsCount = {};

      thoughtChains.forEach(t => {
        const chain = Array.isArray(t.chain) ? t.chain : [];
        if (chain.length === 0) return;
        totalSteps += chain.length;

        // starts / ends
        const startKey = chain[0];
        const endKey = chain[chain.length - 1];
        startCounts[startKey] = (startCounts[startKey] || 0) + 1;
        endCounts[endKey] = (endCounts[endKey] || 0) + 1;

        // usage
        chain.forEach(k => {
          usage[k] = (usage[k] || 0) + 1;
        });

        // transitions
        for (let i = 0; i < chain.length - 1; i++) {
          const k = `${chain[i]}->${chain[i + 1]}`;
          transitions[k] = (transitions[k] || 0) + 1;
        }

        // tags
        if (Array.isArray(t.tags)) {
          t.tags.forEach(tag => {
            const clean = (tag || "").trim().toLowerCase();
            if (!clean) return;
            tagsCount[clean] = (tagsCount[clean] || 0) + 1;
          });
        }
      });

      const avgLength = totalChains > 0 ? totalSteps / totalChains : 0;
      metricTotalElements.textContent = totalElements;
      metricTotalChains.textContent = totalChains;
      metricAvgLength.textContent = avgLength.toFixed(1);

      let mostUsedKey = null;
      let mostUsedCount = 0;
      Object.entries(usage).forEach(([k, v]) => {
        if (v > mostUsedCount) {
          mostUsedCount = v;
          mostUsedKey = k;
        }
      });
      metricMostUsed.textContent = mostUsedKey ? getLabelForKey(mostUsedKey) : "–";

      thoughtCountChip.textContent = `${totalChains} chain${totalChains === 1 ? "" : "s"}`;

      // helper to fill stat boxes
      function fillStatBox(container, map, formatter) {
        container.innerHTML = "";
        const entries = Object.entries(map).sort((a, b) => b[1] - a[1]);
        if (entries.length === 0) {
          const div = document.createElement("div");
          div.className = "mm-stat-empty";
          div.textContent = "No data yet.";
          container.appendChild(div);
          return;
        }
        entries.forEach(([k, v]) => {
          const row = document.createElement("div");
          row.className = "mm-stat-row";
          const left = document.createElement("div");
          left.textContent = formatter(k);
          const right = document.createElement("div");
          right.textContent = v;
          row.appendChild(left);
          row.appendChild(right);
          container.appendChild(row);
        });
      }

      fillStatBox(transitionStatsEl, transitions, k => {
        const [a, b] = k.split("->");
        return `${getLabelForKey(a)} → ${getLabelForKey(b)}`;
      });
      fillStatBox(elementStatsEl, usage, k => getLabelForKey(k));
      fillStatBox(tagStatsEl, tagsCount, tag => "#" + tag);
      fillStatBox(startStatsEl, startCounts, k => getLabelForKey(k));
      fillStatBox(endStatsEl, endCounts, k => getLabelForKey(k));

      renderThoughtHistory();
    }

    function renderThoughtHistory() {
      thoughtHistoryEl.innerHTML = "";
      if (thoughtChains.length === 0) {
        const div = document.createElement("div");
        div.className = "p-2 mm-muted";
        div.textContent = "No chains yet.";
        thoughtHistoryEl.appendChild(div);
        return;
      }

      thoughtChains.forEach(t => {
        const item = document.createElement("div");
        item.className = "mm-history-item";

        const header = document.createElement("div");
        header.className = "d-flex justify-content-between align-items-center mb-1";
        const left = document.createElement("div");
        left.innerHTML = `<strong style="font-size:0.9rem;">Thought</strong>`;
        const right = document.createElement("div");
        right.className = "mm-muted";
        right.style.fontSize = "0.8rem";
        right.textContent = formatTimestamp(t.timestamp);
        header.appendChild(left);
        header.appendChild(right);

        const chainLine = document.createElement("div");
        chainLine.className = "mm-muted";
        chainLine.style.fontSize = "0.85rem";
        const ids = (t.chain || []).map(k => getLabelForKey(k)).join(" → ");
        chainLine.textContent = ids || "(empty chain)";

        const tagsLine = document.createElement("div");
        tagsLine.className = "mt-1";
        if (Array.isArray(t.tags) && t.tags.length > 0) {
          t.tags.forEach(tag => {
            const pill = document.createElement("span");
            pill.className = "mm-tag-pill";
            pill.textContent = "#" + tag;
            tagsLine.appendChild(pill);
          });
        } else {
          const span = document.createElement("span");
          span.className = "mm-muted";
          span.style.fontSize = "0.8rem";
          span.textContent = "No tags";
          tagsLine.appendChild(span);
        }

        const actions = document.createElement("div");
        actions.className = "mt-1 d-flex gap-2";
        const viewContextBtn = document.createElement("button");
        viewContextBtn.className = "btn btn-sm mm-btn-subtle";
        viewContextBtn.textContent = "View context";
        viewContextBtn.addEventListener("click", () => {
          const ctx = t.context || "(no context)";
          openModal("Thought context – " + formatTimestamp(t.timestamp), ctx);
        });

        actions.appendChild(viewContextBtn);

        item.appendChild(header);
        item.appendChild(chainLine);
        item.appendChild(tagsLine);
        item.appendChild(actions);

        thoughtHistoryEl.appendChild(item);
      });
    }

    /* ========== FIRESTORE LOAD/SAVE ========== */
    function loadElementsFromDB() {
      if (!db) {
        renderElements();
        return Promise.resolve();
      }
      return db
        .collection("elements")
        .orderBy("createdAt", "asc")
        .get()
        .then(snap => {
          elements = snap.docs.map(doc => {
            const d = doc.data();
            return { key: doc.id, text: d.text || "", createdAt: d.createdAt || null };
          });
          renderElements();
          logEvent("Elements loaded from Firestore.");
        })
        .catch(err => {
          logEvent("Failed to load elements: " + err.message);
          renderElements();
        });
    }

    function loadThoughtsFromDB() {
      if (!db) {
        renderAnalysis();
        return Promise.resolve();
      }
      return db
        .collection("thoughtChains")
        .orderBy("timestamp", "desc")
        .get()
        .then(snap => {
          thoughtChains = snap.docs.map(doc => {
            const d = doc.data();
            return {
              id: doc.id,
              chain: d.chain || [],
              tags: d.tags || [],
              context: d.context || "",
              timestamp: d.timestamp || null,
            };
          });
          renderAnalysis();
          logEvent("Thought chains loaded from Firestore.");
        })
        .catch(err => {
          logEvent("Failed to load thought chains: " + err.message);
          renderAnalysis();
        });
    }

    function addElement(text) {
      const trimmed = text.trim();
      if (!trimmed) return Promise.resolve();
      if (!db) {
        const key = "local-" + (elements.length + 1);
        elements.push({ key, text: trimmed, createdAt: new Date().toISOString() });
        renderElements();
        logEvent("Element added locally: " + getLabelForKey(key));
        return Promise.resolve();
      }
      return db
        .collection("elements")
        .add({
          text: trimmed,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        })
        .then(() => {
          logEvent("Element added to Firestore.");
          return loadElementsFromDB();
        })
        .catch(err => {
          logEvent("Failed to add element: " + err.message);
        });
    }

    function deleteElementWithThoughts(key) {
      // remove from current chain
      currentChain = currentChain.filter(k => k !== key);
      renderChain();
      // local-only mode
      if (!db) {
        elements = elements.filter(e => e.key !== key);
        thoughtChains = thoughtChains.filter(t => !(t.chain || []).includes(key));
        renderElements();
        renderAnalysis();
        logEvent("Element and related thoughts deleted locally: " + getLabelForKey(key));
        return;
      }
      // Firestore: delete element then all thoughts containing it
      db.collection("elements")
        .doc(key)
        .delete()
        .then(() => {
          logEvent("Element deleted from Firestore: " + key);
          return db
            .collection("thoughtChains")
            .where("chain", "array-contains", key)
            .get();
        })
        .then(snap => {
          const batchPromises = [];
          snap.forEach(doc => {
            batchPromises.push(doc.ref.delete());
          });
          if (batchPromises.length > 0) {
            logEvent("Deleting " + batchPromises.length + " related thought(s) from Firestore.");
          }
          return Promise.all(batchPromises);
        })
        .then(() => {
          return Promise.all([loadElementsFromDB(), loadThoughtsFromDB()]);
        })
        .catch(err => {
          logEvent("Failed to delete element or related thoughts: " + err.message);
        });
    }

    function addToChain(key, doSnapshot = true) {
      if (doSnapshot) snapshotChain();
      currentChain.push(key);
      renderChain();
    }

    function saveChain() {
      if (currentChain.length === 0) {
        alert("Chain is empty.");
        return;
      }
      const tagText = tagsInput.value || "";
      const tags = tagText
        .split(",")
        .map(t => t.trim())
        .filter(Boolean);
      const context = (contextInput.value || "").trim();

      if (!context) {
        if (!confirm("Context is empty. Save anyway?")) return;
      }

      const payload = {
        chain: currentChain.slice(),
        tags,
        context,
      };

      if (!db) {
        payload.id = "local-" + (thoughtChains.length + 1);
        payload.timestamp = new Date().toISOString();
        thoughtChains.unshift(payload);
        renderAnalysis();
        logEvent("Chain saved locally (" + payload.id + ").");
      } else {
        payload.timestamp = firebase.firestore.FieldValue.serverTimestamp();
        db.collection("thoughtChains")
          .add(payload)
          .then(() => {
            logEvent("Chain saved to Firestore.");
            return loadThoughtsFromDB();
          })
          .catch(err => {
            logEvent("Failed to save chain: " + err.message);
          });
      }

      currentChain = [];
      undoStack = [];
      redoStack = [];
      updateUndoRedoButtons();
      tagsInput.value = "";
      contextInput.value = "";
      renderChain();
    }

    /* ========== UNDO / REDO ========== */
    undoChainBtn.addEventListener("click", () => {
      if (undoStack.length === 0) return;
      redoStack.push([...currentChain]);
      currentChain = undoStack.pop();
      renderChain();
      updateUndoRedoButtons();
      logEvent("Chain undo.");
    });

    redoChainBtn.addEventListener("click", () => {
      if (redoStack.length === 0) return;
      undoStack.push([...currentChain]);
      currentChain = redoStack.pop();
      renderChain();
      updateUndoRedoButtons();
      logEvent("Chain redo.");
    });

    /* ========== BUTTON HOOKS ========== */
    addElementBtn.addEventListener("click", () => {
      addElement(newElementText.value).then(() => {
        newElementText.value = "";
      });
    });

    saveChainBtn.addEventListener("click", saveChain);

    clearChainBtn.addEventListener("click", () => {
      if (currentChain.length === 0) return;
      snapshotChain();
      currentChain = [];
      renderChain();
      updateUndoRedoButtons();
      logEvent("Chain cleared.");
    });

    /* ========== BOOTSTRAP ========== */
    (function bootstrapApp() {
      updateUndoRedoButtons();
      loadElementsFromDB().then(loadThoughtsFromDB);
    })();
  </script>
</body>
</html>