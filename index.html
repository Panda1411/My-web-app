<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AstepForward</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCFf_YCZnlmAWd3SLT3DFKwc9L75_2Et-I",
      authDomain: "astepforward-e6c9b.firebaseapp.com",
      projectId: "astepforward-e6c9b",
      storageBucket: "astepforward-e6c9b.firebasestorage.app",
      messagingSenderId: "700253297546",
      appId: "1:700253297546:web:f4d52e14c44e0f1a5f0673",
      measurementId: "G-KJK2CWQ7DF"
    };

    // Init Firebase + Firestore
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Simple per-device user id (no auth yet)
    function getUserId() {
      let id = localStorage.getItem("ds_user_id");
      if (!id) {
        id = "u_" + Math.random().toString(36).slice(2);
        localStorage.setItem("ds_user_id", id);
      }
      return id;
    }
    const userId = "anuj-astepforward";
    
  </script>

  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 16px;
      --bg: #050316;
      --card: #15172b;
      --accent: #7c8cff;
      --accent-soft: rgba(124, 140, 255, 0.18);
      --text-main: #f7f7ff;
      --text-soft: #b3b9d9;
      --bad: #ff5b7a;
      --good: #41d688;
      --border-soft: #262b4a;
      --score-green: #16a34a;
      --score-green-soft: rgba(22, 163, 74, 0.18);
      --prime-purple: #a855f7;
      --prime-purple-soft: rgba(168, 85, 247, 0.18);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      color: var(--text-main);
      background:
        radial-gradient(circle at 10% 20%, rgba(56, 189, 248, 0.12), transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(244, 114, 182, 0.13), transparent 55%),
        radial-gradient(circle at 50% 80%, rgba(129, 140, 248, 0.16), transparent 55%),
        radial-gradient(circle at 0% 100%, rgba(16, 185, 129, 0.1), transparent 55%),
        #020014;
    }

    .app {
      max-width: 720px;
      margin: 0 auto;
      padding: 16px 14px 28px;
    }

    .header {
      margin-bottom: 10px;
    }

    .title {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .subtitle {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .date-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
    }

    .date {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .sync-pill {
      font-size: 0.7rem;
      padding: 3px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(5, 7, 22, 0.8);
      color: var(--text-soft);
    }

    .sync-idle {
      border-color: var(--border-soft);
    }
    .sync-syncing {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
    }
    .sync-synced {
      border-color: rgba(34, 197, 94, 0.9);
      background: rgba(22, 163, 74, 0.18);
      color: #4ade80;
    }
    .sync-error {
      border-color: rgba(248, 113, 113, 0.9);
      background: rgba(248, 113, 113, 0.16);
      color: #fecaca;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.8rem;
      background: var(--accent-soft);
      color: var(--accent);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 0.75rem;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border-soft);
      color: var(--text-soft);
    }

    .nav-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 12px;
    }

    .nav-tab {
      flex: 1;
      text-align: center;
      padding: 7px 0;
      border-radius: 999px;
      font-size: 0.8rem;
      border: 1px solid var(--border-soft);
      background: rgba(6, 9, 26, 0.92);
      color: var(--text-soft);
      cursor: pointer;
    }

    .nav-tab.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .card {
      background: linear-gradient(145deg, rgba(15, 17, 36, 0.98), rgba(7, 9, 24, 0.98));
      border-radius: 16px;
      border: 1px solid var(--border-soft);
      padding: 12px;
      margin-bottom: 10px;
      box-shadow: 0 12px 28px rgba(0, 0, 0, 0.5);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .card-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .score-badge {
      display: inline-flex;
      align-items: baseline;
      gap: 6px;
      padding: 5px 12px;
      border-radius: 999px;
      background: var(--score-green-soft);
      border: 1px solid rgba(22, 163, 74, 0.8);
      box-shadow: 0 0 16px rgba(22, 163, 74, 0.3);
    }

    .score-main {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--score-green);
    }

    .score-label {
      font-size: 0.75rem;
      color: var(--text-soft);
    }

    .pill {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 0.75rem;
      border: 1px solid var(--border-soft);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    input, select, textarea {
      background: #0b0f23;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      padding: 7px 9px;
      color: var(--text-main);
      font-size: 0.85rem;
      width: 100%;
      outline: none;
    }

    textarea {
      min-height: 140px;
      resize: vertical;
    }

    input:focus, select:focus, textarea:focus {
      border-color: var(--accent);
    }

    .task-input-row {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }

    .tasks-list {
      max-height: 200px;
      overflow-y: auto;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.04);
      padding: 4px;
      background: rgba(3,6,18,0.7);
    }

    .task-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 5px 5px;
      margin-bottom: 4px;
      border-radius: 10px;
      background: rgba(14, 19, 44, 0.98);
      font-size: 0.8rem;
      gap: 4px;
    }

    .task-name {
      flex: 1;
      margin-right: 6px;
    }

    .task-name.done {
      text-decoration: line-through;
      opacity: 0.7;
    }

    .task-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 3px;
      justify-content: flex-end;
    }

    .tag {
      border-radius: 999px;
      padding: 1px 6px;
      font-size: 0.65rem;
      border: 1px solid var(--border-soft);
    }

    .tag-sat {
      border-color: rgba(65,214,136,0.8);
      color: var(--good);
    }

    .tag-stress {
      border-color: rgba(255,91,122,0.8);
      color: var(--bad);
    }

    .tag-neutral {
      border-color: rgba(148,163,255,0.8);
      color: var(--text-soft);
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      border-radius: 999px;
      padding: 4px 9px;
      font-size: 0.75rem;
      border: 1px solid var(--border-soft);
      background: rgba(7,10,25,0.95);
      color: var(--text-soft);
      cursor: pointer;
    }

    .chip.active {
      border-color: var(--accent);
      background: var(--accent-soft);
      color: var(--accent);
    }

    .counter-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
    }

    .counter-label {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .counter-controls {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .counter-value {
      min-width: 26px;
      text-align: center;
      font-size: 0.85rem;
    }

    .btn-icon {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      border: 1px solid rgba(124, 140, 255, 0.9);
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.95rem;
      color: var(--accent);
      cursor: pointer;
    }

    .btn-icon:active {
      transform: scale(0.94);
      background: rgba(124, 140, 255, 0.26);
    }

    .insight {
      font-size: 0.76rem;
      color: var(--text-soft);
      margin-top: 6px;
    }

    .footer-note {
      margin-top: 12px;
      font-size: 0.72rem;
      color: #8c92c2;
      text-align: center;
    }

    .motivation-text {
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .motivation-tag {
      font-size: 0.7rem;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .motivation-quote {
      font-size: 0.75rem;
      color: #d1d5ff;
      opacity: 0.9;
      font-style: italic;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .history-list {
      max-height: 260px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.05);
      background: rgba(6, 10, 28, 0.95);
      padding: 4px;
    }

    .history-item {
      padding: 6px 6px;
      border-radius: 8px;
      margin-bottom: 3px;
      font-size: 0.78rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      background: rgba(10, 14, 36, 0.95);
    }

    .history-item:hover {
      background: rgba(17, 24, 56, 0.98);
    }

    .history-item-main {
      display: flex;
      flex-direction: column;
    }

    .history-item-date {
      font-weight: 500;
    }

    .history-item-meta {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .history-item-score {
      font-size: 0.8rem;
      font-weight: 600;
    }

    #historyDetail {
      white-space: pre-line;
      font-size: 0.76rem;
      color: var(--text-soft);
    }

    /* Prime attention card */
    #attentionCard {
      background: radial-gradient(circle at 0% 0%, rgba(168,85,247,0.18), transparent 50%),
                  radial-gradient(circle at 100% 0%, rgba(59,130,246,0.16), transparent 55%),
                  linear-gradient(145deg, #090922, #050319);
      border-width: 1px;
      border-color: rgba(168, 85, 247, 0.8);
      box-shadow: 0 0 26px rgba(168, 85, 247, 0.35);
    }

    ::-webkit-scrollbar {
      width: 4px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #262b4a;
      border-radius: 999px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div>
        <div class="title">AstepForward</div>
        <div class="subtitle">Daily attention, body & mind log</div>
        <div class="date-row">
          <span class="date" id="dateDisplay"></span>
          <span class="sync-pill sync-idle" id="syncStatus">Cloud: local only</span>
        </div>
      </div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" id="tabDashboard">Dashboard</button>
      <button class="nav-tab" id="tabReflection">Reflection</button>
      <button class="nav-tab" id="tabHistory">History</button>
    </div>

    <!-- DASHBOARD PAGE -->
    <div id="dashboardPage" class="page active">
      <!-- Prime Motivation Card -->
      <div class="card" id="motivationCard">
        <div class="card-header">
          <div>
            <div class="card-title">Today’s Nudge</div>
            <div class="card-subtitle">Tiny reminders to tilt the day</div>
          </div>
          <span class="motivation-tag" id="motivationTag">Live</span>
        </div>
        <div class="motivation-text" id="motivationText">
          Start simple: one real task today is already a break in the old pattern.
        </div>
        <div class="motivation-quote" id="motivationQuote">
          Edit quotes in code to make this line yours.
        </div>
      </div>

      <!-- Top score card -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Today's Coherence</div>
            <div class="card-subtitle">How aligned mind + body were</div>
          </div>
          <div class="score-badge">
            <span class="score-main" id="totalScore">0</span>
            <span class="score-label" id="scoreLabel">Baseline</span>
          </div>
        </div>
        <div class="chip-row">
          <div class="pill" id="tasksMini">
            <span class="pill-dot"></span>
            <span id="tasksMiniText">0 tasks</span>
          </div>
          <div class="pill" id="attentionMini">
            <span class="pill-dot"></span>
            <span id="attentionMiniText">Drift 0 / Return 0</span>
          </div>
          <div class="pill" id="bodyMini">
            <span class="pill-dot"></span>
            <span id="bodyMiniText">Body: 0</span>
          </div>
        </div>
        <div class="insight" id="insightText">
          Start logging to let the system see your patterns.
        </div>
      </div>

      <!-- Prime Attention Loop Card -->
      <div class="card" id="attentionCard">
        <div class="card-header">
          <div>
            <div class="card-title">Attention Loop</div>
            <div class="card-subtitle">Where drift meets return</div>
          </div>
        </div>
        <div class="counter-row">
          <div class="counter-label">Drifted into time-waste</div>
          <div class="counter-controls">
            <button class="btn-icon" data-counter="drifts" data-delta="-1">-</button>
            <div class="counter-value" id="driftsValue">0</div>
            <button class="btn-icon" data-counter="drifts" data-delta="1">+</button>
          </div>
        </div>
        <div class="counter-row">
          <div class="counter-label">Caught yourself & returned</div>
          <div class="counter-controls">
            <button class="btn-icon" data-counter="returns" data-delta="-1">-</button>
            <div class="counter-value" id="returnsValue">0</div>
            <button class="btn-icon" data-counter="returns" data-delta="1">+</button>
          </div>
        </div>
      </div>

      <!-- Grid: Mindfulness + Body -->
      <div class="grid">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Mindfulness</div>
              <div class="card-subtitle">Awareness checks & presence</div>
            </div>
          </div>
          <div class="counter-row">
            <div class="counter-label">Mindful check-ins</div>
            <div class="counter-controls">
              <button class="btn-icon" data-counter="mindfulness" data-delta="-1">-</button>
              <div class="counter-value" id="mindfulnessValue">0</div>
              <button class="btn-icon" data-counter="mindfulness" data-delta="1">+</button>
            </div>
          </div>
          <div class="counter-row">
            <div class="counter-label">Minutes in pure presence</div>
            <div class="counter-controls">
              <button class="btn-icon" data-counter="presence" data-delta="-5">-</button>
              <div class="counter-value" id="presenceValue">0</div>
              <button class="btn-icon" data-counter="presence" data-delta="5">+5</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Body: Sunlight & Exercise</div>
              <div class="card-subtitle">Physical stabilisers</div>
            </div>
          </div>
          <div class="counter-row">
            <div class="counter-label">Sunlight (minutes)</div>
            <div class="counter-controls">
              <button class="btn-icon" data-counter="sunlight" data-delta="-5">-</button>
              <div class="counter-value" id="sunlightValue">0</div>
              <button class="btn-icon" data-counter="sunlight" data-delta="5">+5</button>
            </div>
          </div>
          <div class="counter-row">
            <div class="counter-label">Eye-sight exercise (minutes)</div>
            <div class="counter-controls">
              <button class="btn-icon" data-counter="eyesight" data-delta="-5">-</button>
              <div class="counter-value" id="eyesightValue">0</div>
              <button class="btn-icon" data-counter="eyesight" data-delta="5">+5</button>
            </div>
          </div>
          <div style="margin-top:6px;">
            <div class="counter-label" style="margin-bottom:3px;">Exercise</div>
            <div class="chip-row" id="exerciseChips">
              <div class="chip" data-exercise="none">None</div>
              <div class="chip" data-exercise="light">Light</div>
              <div class="chip" data-exercise="moderate">Moderate</div>
              <div class="chip" data-exercise="intense">Intense</div>
            </div>
          </div>
          <div style="margin-top:6px;">
            <div class="counter-label" style="margin-bottom:3px;">Hygiene</div>
            <div class="chip-row">
              <div class="chip" data-hygiene="brushed">Brushed</div>
              <div class="chip" data-hygiene="bathed">Bath</div>
              <div class="chip" data-hygiene="clothes">Clean clothes</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Food / Sleep -->
      <div class="grid">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Food & Water</div>
              <div class="card-subtitle">Fuel pattern</div>
            </div>
          </div>
          <div class="counter-row">
            <div class="counter-label">Good meals</div>
            <div class="counter-controls">
              <button class="btn-icon" data-counter="goodMeals" data-delta="-1">-</button>
              <div class="counter-value" id="goodMealsValue">0</div>
              <button class="btn-icon" data-counter="goodMeals" data-delta="1">+</button>
            </div>
          </div>
          <div class="counter-row">
            <div class="counter-label">Bad meals</div>
            <div class="counter-controls">
              <button class="btn-icon" data-counter="badMeals" data-delta="-1">-</button>
              <div class="counter-value" id="badMealsValue">0</div>
              <button class="btn-icon" data-counter="badMeals" data-delta="1">+</button>
            </div>
          </div>
          <div class="counter-row" style="margin-top:6px;">
            <div class="counter-label">Water enough?</div>
            <div class="chip-row">
              <div class="chip" id="waterChip" data-water="false">No / Not sure</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Sleep</div>
              <div class="card-subtitle">Recovery quality</div>
            </div>
          </div>
          <div style="margin-top:4px;">
            <div class="counter-label" style="margin-bottom:3px;">Sleep quality</div>
            <div class="chip-row" id="sleepChips">
              <div class="chip" data-sleep="0">Bad</div>
              <div class="chip" data-sleep="1">Okay</div>
              <div class="chip" data-sleep="2">Good</div>
              <div class="chip" data-sleep="3">Great</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tasks -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Tasks</div>
            <div class="card-subtitle">Study, chapters, any focused work</div>
          </div>
          <button class="btn btn-small" id="clearTasksBtn">Clear tasks</button>
        </div>
        <div class="task-input-row">
          <input id="taskInput" placeholder="Add a task e.g. 'Physics Ch 1'" />
          <button class="btn btn-small" id="addTaskBtn">Add</button>
        </div>
        <div class="tasks-list" id="tasksList"></div>
      </div>

      <!-- History / Backup -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Backup</div>
          <button class="btn btn-small btn-outline" id="exportBtn">Export JSON</button>
        </div>
        <div class="card-subtitle">
          Export your data sometimes and save it in Drive/Notes to avoid total loss if browser data is cleared.
        </div>
      </div>

      <div class="footer-note">
        This is your personal lab. Scores are not moral; they’re just a map.
      </div>
    </div>

    <!-- REFLECTION PAGE -->
    <div id="reflectionPage" class="page">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">End of Day Reflection</div>
            <div class="card-subtitle">Your perception of this day</div>
          </div>
        </div>
        <textarea id="reflectionText" placeholder="Write how the day felt, what patterns you noticed, where drift pulled you, where you surprised yourself..."></textarea>
        <div style="margin-top:6px; text-align:right;">
          <button class="btn btn-small" id="saveReflectionBtn">Save</button>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Today in One Glance</div>
        </div>
        <div class="card-subtitle" id="reflectionSummary">
          Once you log some data on the dashboard, a quick summary of the day will appear here.
        </div>
      </div>

      <div class="footer-note">
        Reflection turns raw data into understanding. Even a few lines are enough.
      </div>
    </div>

    <!-- HISTORY PAGE -->
    <div id="historyPage" class="page">
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Past Days</div>
            <div class="card-subtitle">Tap a day to inspect its structure</div>
          </div>
        </div>
        <div class="history-list" id="historyList"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Day Detail</div>
        </div>
        <div id="historyDetail">
          Select a day above to see scores, loops and reflection.
        </div>
      </div>

      <div class="footer-note">
        History is just a record of previous vectors. You adjust the next one.
      </div>
    </div>
  </div>

  <script>
    // ====== BASIC UTILITIES + DATA SHAPE ======
    function todayKey() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, "0");
      const dd = String(d.getDate()).padStart(2, "0");
      return `daylog-${yyyy}-${mm}-${dd}`;
    }

    function formatToday() {
      const d = new Date();
      const options = { weekday: "short", day: "numeric", month: "short", year: "numeric" };
      return d.toLocaleDateString(undefined, options);
    }

    function makeEmptyDay(key) {
      return {
        key: key || todayKey(),
        dateString: formatToday(),
        tasks: [],
        drifts: 0,
        returns: 0,
        mindfulness: 0,
        presence: 0,
        sunlight: 0,
        eyesight: 0,
        exercise: "none",
        hygiene: { brushed: false, bathed: false, clothes: false },
        goodMeals: 0,
        badMeals: 0,
        waterOk: false,
        sleepQuality: null,
        journal: ""
      };
    }

    function ensureDayShape(day, keyOverride) {
      if (!day || typeof day !== "object") {
        return makeEmptyDay(keyOverride);
      }
      if (day.tasks == null) day.tasks = [];
      if (day.drifts == null) day.drifts = 0;
      if (day.returns == null) day.returns = 0;
      if (day.mindfulness == null) day.mindfulness = 0;
      if (day.presence == null) day.presence = 0;
      if (day.sunlight == null) day.sunlight = 0;
      if (day.eyesight == null) day.eyesight = 0;
      if (!day.exercise) day.exercise = "none";
      if (!day.hygiene) day.hygiene = { brushed: false, bathed: false, clothes: false };
      if (day.goodMeals == null) day.goodMeals = 0;
      if (day.badMeals == null) day.badMeals = 0;
      if (day.waterOk == null) day.waterOk = false;
      if (day.sleepQuality == null && day.sleepQuality !== 0) day.sleepQuality = null;
      if (day.journal == null) day.journal = "";
      if (!day.key) day.key = keyOverride || todayKey();
      if (!day.dateString) day.dateString = formatToday();
      return day;
    }

    let currentDay = null;
    let syncState = "idle"; // "idle" | "syncing" | "synced" | "error";

    function loadDay(key) {
      const useKey = key || todayKey();
      const raw = localStorage.getItem(useKey);

      if (raw) {
        const parsed = ensureDayShape(JSON.parse(raw), useKey);
        fetchDayFromCloud(useKey);
        return parsed;
      }

      const fresh = makeEmptyDay(useKey);
      fetchDayFromCloud(useKey);
      return fresh;
    }

    function fetchDayFromCloud(dayKey) {
      db.collection("users")
        .doc(userId)
        .collection("days")
        .doc(dayKey)
        .get()
        .then(doc => {
          if (doc.exists) {
            const data = ensureDayShape(doc.data(), dayKey);
            localStorage.setItem(dayKey, JSON.stringify(data));
            let all = [];
            try {
              all = JSON.parse(localStorage.getItem("daylog-keys") || "[]");
            } catch {
              all = [];
            }
            if (!all.includes(dayKey)) {
              all.push(dayKey);
              localStorage.setItem("daylog-keys", JSON.stringify(all));
            }
            if (currentDay && currentDay.key === dayKey) {
              currentDay = data;
              render();
            }
            syncState = "synced";
            renderSyncStatus();
          }
        })
        .catch(err => {
          console.error("Cloud load failed:", err);
        });
    }

    function saveDay(day) {
      // Local save
      localStorage.setItem(day.key, JSON.stringify(day));
      let all = [];
      try {
        all = JSON.parse(localStorage.getItem("daylog-keys") || "[]");
      } catch {
        all = [];
      }
      if (!all.includes(day.key)) {
        all.push(day.key);
        localStorage.setItem("daylog-keys", JSON.stringify(all));
      }

      // Cloud save
      syncState = "syncing";
      renderSyncStatus();
      db.collection("users")
        .doc(userId)
        .collection("days")
        .doc(day.key)
        .set(day)
        .then(() => {
          syncState = "synced";
          renderSyncStatus();
        })
        .catch(err => {
          console.error("Cloud sync failed:", err);
          syncState = "error";
          renderSyncStatus();
        });
    }

    // ====== SCORE CALCULATION (reusable) ======
    function computeScore(day) {
      const doneTasks = day.tasks.filter(t => t.done);
      const taskCount = doneTasks.length;
      let taskScore = 0;
      doneTasks.forEach(t => {
        if (t.mood === "satisfied") taskScore += 3;
        else if (t.mood === "neutral") taskScore += 2;
        else if (t.mood === "stressed") taskScore += 1;
        else taskScore += 1.5;
      });

      const drift = day.drifts;
      const ret = day.returns;
      let attentionScore = ret * 2 - drift * 1;
      if (attentionScore < 0) attentionScore = 0;

      let mindScore = day.mindfulness * 0.7;
      if (day.presence >= 10) mindScore += 4;
      else if (day.presence >= 5) mindScore += 2;
      else if (day.presence >= 2) mindScore += 1;

      let bodyScore = 0;
      if (day.sunlight >= 120) bodyScore += 4;
      else if (day.sunlight >= 60) bodyScore += 2;
      else if (day.sunlight >= 30) bodyScore += 1;

      if (day.eyesight >= 30) bodyScore += 3;
      else if (day.eyesight >= 10) bodyScore += 2;
      else if (day.eyesight >= 5) bodyScore += 1;

      if (day.exercise === "light") bodyScore += 1;
      else if (day.exercise === "moderate") bodyScore += 3;
      else if (day.exercise === "intense") bodyScore += 4;

      if (day.hygiene.brushed) bodyScore += 0.5;
      if (day.hygiene.bathed) bodyScore += 1;
      if (day.hygiene.clothes) bodyScore += 0.5;

      let foodScore = day.goodMeals * 1.5 - day.badMeals * 1.5;
      if (foodScore < -4) foodScore = -4;

      if (day.waterOk) bodyScore += 1.5;

      let restScore = 0;
      if (day.sleepQuality === 1) restScore += 1;
      else if (day.sleepQuality === 2) restScore += 2.5;
      else if (day.sleepQuality === 3) restScore += 4;

      const total = Math.round(taskScore + attentionScore + mindScore + bodyScore + foodScore + restScore);

      let label = "Baseline";
      if (total >= 60) label = "Very coherent";
      else if (total >= 40) label = "Stable";
      else if (total >= 20) label = "Developing pattern";
      else label = "Just starting";

      return {
        total,
        label,
        taskCount,
        drift,
        ret,
        bodyScore,
        mindScore,
        foodScore,
        restScore,
        doneTasks
      };
    }

    function buildInsight(meta) {
      const { total, taskCount, drift, ret, bodyScore, mindScore, foodScore, restScore } = meta;

      if (taskCount === 0 && drift === 0 && ret === 0) {
        return "Today is blank data. Even a single logged action turns the day into an experiment instead of a blur.";
      }

      if (ret > drift && ret > 0) {
        return "You returned from drift more often than you fell into it. Your mind is learning that 'coming back' is possible.";
      }

      if (drift > ret && drift >= 3) {
        return "Drift dominated today. One tiny extra return moment tomorrow is already a physics change in your attention.";
      }

      if (bodyScore >= 6 && taskCount > 0) {
        return "Body inputs (sunlight, exercise, hygiene, eyes) were high. This is the kind of base that usually stabilises thought loops.";
      }

      if (foodScore < 0 && total < 20) {
        return "Food pattern pulled your system down a bit. Light, clean meals on study days can quietly boost attention quality.";
      }

      if (mindScore >= 4) {
        return "Mindfulness density was strong. Awareness is already active; now it just needs repeated small triggers.";
      }

      if (restScore === 0 && total < 20) {
        return "Sleep quality looks low. Tired systems drift more and resist tasks — this is mechanics, not weakness.";
      }

      return "Data is forming. Keep logging for a few days and your patterns will become impossible to ignore.";
    }

    // ====== DOM ELEMENTS ======
    const dateDisplay = document.getElementById("dateDisplay");
    const syncStatusEl = document.getElementById("syncStatus");

    const totalScoreEl = document.getElementById("totalScore");
    const scoreLabelEl = document.getElementById("scoreLabel");
    const tasksMiniText = document.getElementById("tasksMiniText");
    const attentionMiniText = document.getElementById("attentionMiniText");
    const bodyMiniText = document.getElementById("bodyMiniText");
    const insightText = document.getElementById("insightText");

    const motivationText = document.getElementById("motivationText");
    const motivationTag = document.getElementById("motivationTag");
    const motivationQuote = document.getElementById("motivationQuote");

    const taskInput = document.getElementById("taskInput");
    const addTaskBtn = document.getElementById("addTaskBtn");
    const clearTasksBtn = document.getElementById("clearTasksBtn");
    const tasksList = document.getElementById("tasksList");

    const driftsValue = document.getElementById("driftsValue");
    const returnsValue = document.getElementById("returnsValue");
    const mindfulnessValue = document.getElementById("mindfulnessValue");
    const presenceValue = document.getElementById("presenceValue");
    const sunlightValue = document.getElementById("sunlightValue");
    const eyesightValue = document.getElementById("eyesightValue");
    const goodMealsValue = document.getElementById("goodMealsValue");
    const badMealsValue = document.getElementById("badMealsValue");

    const exerciseChips = document.getElementById("exerciseChips");
    const sleepChips = document.getElementById("sleepChips");
    const waterChip = document.getElementById("waterChip");
    const hygieneChips = document.querySelectorAll("[data-hygiene]");

    const exportBtn = document.getElementById("exportBtn");

    const tabDashboard = document.getElementById("tabDashboard");
    const tabReflection = document.getElementById("tabReflection");
    const tabHistory = document.getElementById("tabHistory");
    const dashboardPage = document.getElementById("dashboardPage");
    const reflectionPage = document.getElementById("reflectionPage");
    const historyPage = document.getElementById("historyPage");
    const reflectionText = document.getElementById("reflectionText");
    const saveReflectionBtn = document.getElementById("saveReflectionBtn");
    const reflectionSummary = document.getElementById("reflectionSummary");

    const historyList = document.getElementById("historyList");
    const historyDetail = document.getElementById("historyDetail");

    // ====== SYNC STATUS UI ======
    function renderSyncStatus() {
      syncStatusEl.className = "sync-pill";
      let text = "Cloud: local only";
      if (syncState === "idle") {
        syncStatusEl.classList.add("sync-idle");
        text = "Cloud: local only";
      } else if (syncState === "syncing") {
        syncStatusEl.classList.add("sync-syncing");
        text = "Cloud: syncing…";
      } else if (syncState === "synced") {
        syncStatusEl.classList.add("sync-synced");
        text = "Cloud: synced";
      } else if (syncState === "error") {
        syncStatusEl.classList.add("sync-error");
        text = "Cloud: error";
      }
      syncStatusEl.textContent = text;
    }

    // ====== RENDER CURRENT DAY ======
    function render() {
      dateDisplay.textContent = currentDay.dateString;

      driftsValue.textContent = currentDay.drifts;
      returnsValue.textContent = currentDay.returns;
      mindfulnessValue.textContent = currentDay.mindfulness;
      presenceValue.textContent = currentDay.presence;
      sunlightValue.textContent = currentDay.sunlight;
      eyesightValue.textContent = currentDay.eyesight;
      goodMealsValue.textContent = currentDay.goodMeals;
      badMealsValue.textContent = currentDay.badMeals;

      Array.from(exerciseChips.querySelectorAll(".chip")).forEach(chip => {
        const val = chip.getAttribute("data-exercise");
        chip.classList.toggle("active", val === currentDay.exercise);
      });

      hygieneChips.forEach(chip => {
        const key = chip.getAttribute("data-hygiene");
        const flag =
          key === "brushed"
            ? currentDay.hygiene.brushed
            : key === "bathed"
            ? currentDay.hygiene.bathed
            : currentDay.hygiene.clothes;
        chip.classList.toggle("active", !!flag);
      });

      waterChip.classList.toggle("active", currentDay.waterOk);
      waterChip.textContent = currentDay.waterOk ? "Yes" : "No / Not sure";

      Array.from(sleepChips.querySelectorAll(".chip")).forEach(chip => {
        const val = parseInt(chip.getAttribute("data-sleep"), 10);
        chip.classList.toggle("active", currentDay.sleepQuality === val);
      });

      renderTasks();
      computeAndRenderScoreForCurrent();
      renderReflection();
      renderMotivation();
    }

    function renderTasks() {
      tasksList.innerHTML = "";
      if (!currentDay.tasks.length) {
        const empty = document.createElement("div");
        empty.style.fontSize = "0.78rem";
        empty.style.color = "#7f86aa";
        empty.textContent = "No tasks yet. Add one above after doing real work.";
        tasksList.appendChild(empty);
        return;
      }

      currentDay.tasks.forEach((task, idx) => {
        const row = document.createElement("div");
        row.className = "task-item";

        const nameDiv = document.createElement("div");
        nameDiv.className = "task-name";
        if (task.done) {
          nameDiv.classList.add("done");
        }
        nameDiv.textContent = task.title;
        row.appendChild(nameDiv);

        const tagContainer = document.createElement("div");
        tagContainer.className = "task-tags";

        const doneBtn = document.createElement("button");
        doneBtn.className = "btn btn-small";
        doneBtn.textContent = task.done ? "✓" : "Done";
        doneBtn.style.fontSize = "0.7rem";
        doneBtn.onclick = () => {
          task.done = !task.done;
          saveDay(currentDay);
          render();
        };
        tagContainer.appendChild(doneBtn);

        const satBtn = document.createElement("button");
        satBtn.className = "btn btn-small btn-outline";
        satBtn.textContent = "Sat";
        satBtn.style.fontSize = "0.7rem";
        satBtn.onclick = () => {
          task.mood = "satisfied";
          saveDay(currentDay);
          render();
        };

        const neuBtn = document.createElement("button");
        neuBtn.className = "btn btn-small btn-outline";
        neuBtn.textContent = "Neutral";
        neuBtn.style.fontSize = "0.7rem";
        neuBtn.onclick = () => {
          task.mood = "neutral";
          saveDay(currentDay);
          render();
        };

        const stressBtn = document.createElement("button");
        stressBtn.className = "btn btn-small btn-outline";
        stressBtn.textContent = "Stress";
        stressBtn.style.fontSize = "0.7rem";
        stressBtn.onclick = () => {
          task.mood = "stressed";
          saveDay(currentDay);
          render();
        };

        tagContainer.appendChild(satBtn);
        tagContainer.appendChild(neuBtn);
        tagContainer.appendChild(stressBtn);

        if (task.mood) {
          const tag = document.createElement("span");
          tag.className = "tag";
          if (task.mood === "satisfied") tag.classList.add("tag-sat");
          if (task.mood === "neutral") tag.classList.add("tag-neutral");
          if (task.mood === "stressed") tag.classList.add("tag-stress");
          tag.textContent = task.mood;
          tagContainer.appendChild(tag);
        }

        const removeBtn = document.createElement("button");
        removeBtn.className = "btn btn-small btn-outline";
        removeBtn.textContent = "X";
        removeBtn.style.fontSize = "0.7rem";
        removeBtn.onclick = () => {
          currentDay.tasks.splice(idx, 1);
          saveDay(currentDay);
          render();
        };
        tagContainer.appendChild(removeBtn);

        row.appendChild(tagContainer);
        tasksList.appendChild(row);
      });
    }

    function computeAndRenderScoreForCurrent() {
      const meta = computeScore(currentDay);
      totalScoreEl.textContent = meta.total;
      scoreLabelEl.textContent = meta.label;

      tasksMiniText.textContent = `${meta.taskCount} task${meta.taskCount === 1 ? "" : "s"} done`;
      attentionMiniText.textContent = `Drift ${meta.drift} / Return ${meta.ret}`;
      bodyMiniText.textContent = `Body: ${Math.round(meta.bodyScore)}`;

      insightText.textContent = buildInsight(meta);
    }

    // ====== REFLECTION ======
    function renderReflection() {
      reflectionText.value = currentDay.journal || "";

      const meta = computeScore(currentDay);
      const doneTasks = meta.doneTasks;
      const satisfied = doneTasks.filter(t => t.mood === "satisfied").length;
      const stressed = doneTasks.filter(t => t.mood === "stressed").length;

      let summary = "";
      if (meta.taskCount === 0 && currentDay.drifts === 0 && currentDay.returns === 0) {
        summary = "No significant data logged yet. Even one task and one drift/return entry turns this from a vague day into a measurable one.";
      } else {
        summary += `Total score: ${meta.total} (${meta.label}).\n`;
        summary += `Tasks done: ${meta.taskCount} (Sat: ${satisfied}, Stress: ${stressed}).\n`;
        summary += `Attention: drifted ${currentDay.drifts} times, returned ${currentDay.returns} times.\n`;
        if (currentDay.sunlight > 0 || currentDay.exercise !== "none") {
          summary += `Body inputs: sunlight ${currentDay.sunlight} min, exercise: ${currentDay.exercise}.\n`;
        }
        if (currentDay.eyesight > 0) {
          summary += `Eye-sight exercise: ${currentDay.eyesight} minutes.\n`;
        }
        if (currentDay.goodMeals > 0 || currentDay.badMeals > 0) {
          summary += `Food: ${currentDay.goodMeals} good / ${currentDay.badMeals} bad meals.\n`;
        }
      }

      reflectionSummary.textContent = summary.trim();
    }

    // ====== MOTIVATION & QUOTES ======
    const userQuotes = [
      "You don’t need a perfect orbit, just a slightly better vector today.",
      "Attention returning is more powerful than attention never drifting.",
      "Small honest work now is future you’s favourite memory.",
      "Even one clear step forward is enough to change the slope."
    ];

    function pickQuote() {
      if (!userQuotes.length) return "";
      const hour = new Date().getHours();
      const idx = hour % userQuotes.length;
      return userQuotes[idx];
    }

    function renderMotivation() {
      const hour = new Date().getHours();
      const meta = computeScore(currentDay);
      const doneTasks = meta.doneTasks;
      const satisfied = doneTasks.filter(t => t.mood === "satisfied").length;
      const stressed = doneTasks.filter(t => t.mood === "stressed").length;
      const drift = currentDay.drifts;
      const ret = currentDay.returns;

      let tag = "Live";
      let text = "";

      if (doneTasks.length === 0 && drift === 0 && ret === 0) {
        tag = hour < 12 ? "Start" : "Reset";
        text = "You don't need a perfect schedule. One honest, small task today already breaks yesterday's pattern.";
      } else if (ret > drift && ret > 0) {
        tag = "Return Power";
        text = "You’re already proving you can come back from drift. Keep practising the 'return'—it’s the real superpower.";
      } else if (drift > ret + 1) {
        tag = "Soft Push";
        text = "Drift pulled more than return today. Try one extra conscious return, even if it’s just closing a tab and taking a breath.";
      } else if (satisfied > stressed) {
        tag = "Aligned Work";
        text = "More of your tasks ended in satisfaction than stress. This is the texture of sustainable effort—keep nudging in that direction.";
      } else if (currentDay.sunlight >= 15 && currentDay.exercise !== "none") {
        tag = "Body First";
        text = "Your body inputs look decent. With this base, even 10 minutes of focused study can land deeper.";
      } else if (currentDay.mindfulness >= 5) {
        tag = "Aware";
        text = "Your awareness is already online. Use it to catch just one loop earlier than usual.";
      } else {
        if (hour < 12) {
          tag = "Morning Edge";
          text = "Give this morning one real task. Your evening self will remember this as the moment the day tilted.";
        } else if (hour < 18) {
          tag = "Midday Pivot";
          text = "The day is not decided yet. One focused block now can rewrite how you remember today.";
        } else {
          tag = "Night Rewrite";
          text = "Even late in the day, a small action—5 minutes reading, one page of notes—can stop today from becoming another blur.";
        }
      }

      motivationTag.textContent = tag;
      motivationText.textContent = text;
      motivationQuote.textContent = pickQuote();
    }

    // ====== HISTORY ======
    function refreshHistoryFromCloud() {
      db.collection("users")
        .doc(userId)
        .collection("days")
        .get()
        .then(snapshot => {
          snapshot.forEach(doc => {
            const data = ensureDayShape(doc.data(), doc.id);
            localStorage.setItem(data.key, JSON.stringify(data));
            let all = [];
            try {
              all = JSON.parse(localStorage.getItem("daylog-keys") || "[]");
            } catch {
              all = [];
            }
            if (!all.includes(data.key)) {
              all.push(data.key);
              localStorage.setItem("daylog-keys", JSON.stringify(all));
            }
          });
          buildHistoryList();
        })
        .catch(err => {
          console.error("History cloud fetch failed:", err);
        });
    }

    function buildHistoryList() {
      historyList.innerHTML = "";
      let keys = [];
      try {
        keys = JSON.parse(localStorage.getItem("daylog-keys") || "[]");
      } catch {
        keys = [];
      }
      if (!keys.length) {
        const empty = document.createElement("div");
        empty.style.fontSize = "0.78rem";
        empty.style.color = "#7f86aa";
        empty.textContent = "No past days recorded yet. Use the dashboard for a few days and check back.";
        historyList.appendChild(empty);
        return;
      }

      keys.sort().reverse(); // newest first
      keys.forEach(key => {
        const raw = localStorage.getItem(key);
        if (!raw) return;
        let day;
        try {
          day = ensureDayShape(JSON.parse(raw), key);
        } catch {
          return;
        }
        const meta = computeScore(day);

        const item = document.createElement("div");
        item.className = "history-item";

        const left = document.createElement("div");
        left.className = "history-item-main";

        const dateEl = document.createElement("div");
        dateEl.className = "history-item-date";
        dateEl.textContent = day.dateString || key;

        const metaEl = document.createElement("div");
        metaEl.className = "history-item-meta";
        metaEl.textContent = `Drift ${day.drifts}, Return ${day.returns}`;

        left.appendChild(dateEl);
        left.appendChild(metaEl);

        const scoreEl = document.createElement("div");
        scoreEl.className = "history-item-score";
        scoreEl.textContent = meta.total;

        item.appendChild(left);
        item.appendChild(scoreEl);

        item.addEventListener("click", () => {
          renderHistoryDetail(day);
        });

        historyList.appendChild(item);
      });
    }

    function renderHistoryDetail(day) {
      const meta = computeScore(day);
      const doneTasks = meta.doneTasks;
      const satisfied = doneTasks.filter(t => t.mood === "satisfied").length;
      const stressed = doneTasks.filter(t => t.mood === "stressed").length;

      let text = "";
      text += `${day.dateString || day.key}\n`;
      text += `Total score: ${meta.total} (${meta.label})\n\n`;
      text += `Tasks done: ${meta.taskCount} (Sat: ${satisfied}, Stress: ${stressed})\n`;
      text += `Attention: Drift ${day.drifts}, Return ${day.returns}\n`;
      text += `Mindfulness: ${day.mindfulness} checks, ${day.presence} min presence\n`;
      text += `Sunlight: ${day.sunlight} min, Eye-sight: ${day.eyesight} min\n`;
      text += `Exercise: ${day.exercise}\n`;
      text += `Hygiene: brushed=${day.hygiene.brushed ? "yes" : "no"}, bath=${day.hygiene.bathed ? "yes" : "no"}, clothes=${day.hygiene.clothes ? "yes" : "no"}\n`;
      text += `Food: ${day.goodMeals} good / ${day.badMeals} bad meals, water=${day.waterOk ? "enough" : "uncertain"}\n`;
      text += `Sleep quality: ${
        day.sleepQuality === null ? "not rated" :
        day.sleepQuality === 0 ? "Bad" :
        day.sleepQuality === 1 ? "Okay" :
        day.sleepQuality === 2 ? "Good" : "Great"
      }\n`;

      if (day.journal && day.journal.trim()) {
        text += `\nReflection:\n${day.journal.trim()}`;
      }

      historyDetail.textContent = text;
    }

    // ====== TAB SWITCHING ======
    function setPage(page) {
      if (page === "dashboard") {
        dashboardPage.classList.add("active");
        reflectionPage.classList.remove("active");
        historyPage.classList.remove("active");
        tabDashboard.classList.add("active");
        tabReflection.classList.remove("active");
        tabHistory.classList.remove("active");
      } else if (page === "reflection") {
        dashboardPage.classList.remove("active");
        reflectionPage.classList.add("active");
        historyPage.classList.remove("active");
        tabDashboard.classList.remove("active");
        tabReflection.classList.add("active");
        tabHistory.classList.remove("active");
      } else if (page === "history") {
        dashboardPage.classList.remove("active");
        reflectionPage.classList.remove("active");
        historyPage.classList.add("active");
        tabDashboard.classList.remove("active");
        tabReflection.classList.remove("active");
        tabHistory.classList.add("active");
        buildHistoryList();
        refreshHistoryFromCloud();
      }
    }

    tabDashboard.addEventListener("click", () => setPage("dashboard"));
    tabReflection.addEventListener("click", () => setPage("reflection"));
    tabHistory.addEventListener("click", () => setPage("history"));

    // ====== EVENTS ======
    addTaskBtn.addEventListener("click", () => {
      const title = taskInput.value.trim();
      if (!title) return;
      currentDay.tasks.push({
        id: Date.now(),
        title,
        done: false,
        mood: null
      });
      taskInput.value = "";
      saveDay(currentDay);
      render();
    });

    taskInput.addEventListener("keydown", e => {
      if (e.key === "Enter") addTaskBtn.click();
    });

    clearTasksBtn.addEventListener("click", () => {
      if (!confirm("Clear tasks for today? This only affects this day's data.")) return;
      currentDay.tasks = [];
      saveDay(currentDay);
      render();
    });

    document.body.addEventListener("click", e => {
      const btn = e.target.closest(".btn-icon");
      if (!btn) return;
      const counter = btn.getAttribute("data-counter");
      const delta = parseInt(btn.getAttribute("data-delta"), 10);
      if (!counter) return;

      if (counter === "drifts") {
        currentDay.drifts = Math.max(0, currentDay.drifts + delta);
      } else if (counter === "returns") {
        currentDay.returns = Math.max(0, currentDay.returns + delta);
      } else if (counter === "mindfulness") {
        currentDay.mindfulness = Math.max(0, currentDay.mindfulness + delta);
      } else if (counter === "presence") {
        currentDay.presence = Math.max(0, currentDay.presence + delta);
      } else if (counter === "sunlight") {
        currentDay.sunlight = Math.max(0, currentDay.sunlight + delta);
      } else if (counter === "eyesight") {
        currentDay.eyesight = Math.max(0, currentDay.eyesight + delta);
      } else if (counter === "goodMeals") {
        currentDay.goodMeals = Math.max(0, currentDay.goodMeals + delta);
      } else if (counter === "badMeals") {
        currentDay.badMeals = Math.max(0, currentDay.badMeals + delta);
      }

      saveDay(currentDay);
      render();
    });

    exerciseChips.addEventListener("click", e => {
      const chip = e.target.closest(".chip");
      if (!chip) return;
      const val = chip.getAttribute("data-exercise");
      currentDay.exercise = val;
      saveDay(currentDay);
      render();
    });

    sleepChips.addEventListener("click", e => {
      const chip = e.target.closest(".chip");
      if (!chip) return;
      const val = parseInt(chip.getAttribute("data-sleep"), 10);
      currentDay.sleepQuality = val;
      saveDay(currentDay);
      render();
    });

    hygieneChips.forEach(chip => {
      chip.addEventListener("click", () => {
        const key = chip.getAttribute("data-hygiene");
        if (key === "brushed") currentDay.hygiene.brushed = !currentDay.hygiene.brushed;
        if (key === "bathed") currentDay.hygiene.bathed = !currentDay.hygiene.bathed;
        if (key === "clothes") currentDay.hygiene.clothes = !currentDay.hygiene.clothes;
        saveDay(currentDay);
        render();
      });
    });

    waterChip.addEventListener("click", () => {
      currentDay.waterOk = !currentDay.waterOk;
      saveDay(currentDay);
      render();
    });

    exportBtn.addEventListener("click", () => {
      let keys = [];
      try {
        keys = JSON.parse(localStorage.getItem("daylog-keys") || "[]");
      } catch {
        keys = [];
      }
      const allDays = keys.map(k => {
        try {
          return JSON.parse(localStorage.getItem(k) || "{}");
        } catch {
          return {};
        }
      });
      const blob = new Blob([JSON.stringify(allDays, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const ts = new Date().toISOString().split("T")[0];
      a.href = url;
      a.download = `astepforward-export-${ts}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    saveReflectionBtn.addEventListener("click", () => {
      currentDay.journal = reflectionText.value || "";
      saveDay(currentDay);
      renderReflection();
      alert("Reflection saved for today.");
    });

    // ====== MIDNIGHT ROLLOVER ======
    function scheduleMidnightRollover() {
      const now = new Date();
      const next = new Date(now);
      next.setHours(24, 0, 0, 0); // next midnight
      const ms = next.getTime() - now.getTime();
      setTimeout(() => {
        currentDay = makeEmptyDay(todayKey());
        saveDay(currentDay);
        render();
        scheduleMidnightRollover(); // schedule next
      }, ms);
    }

    // ====== INIT ======
    currentDay = loadDay(todayKey());
    currentDay = ensureDayShape(currentDay, todayKey());
    saveDay(currentDay);
    renderSyncStatus();
    render();
    scheduleMidnightRollover();
    
    // Every 60 seconds, pull latest data for today from cloud
setInterval(() => fetchDayFromCloud(todayKey()), 300 * 1000);
  </script>
</body>
</html>